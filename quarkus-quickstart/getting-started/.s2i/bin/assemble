#!/bin/bash

# Run additional build before steps

# Execute original assemble script
/usr/libexec/s2i/assemble

# Run additional build after steps
jarfile="$project/deployments/quarkus-app/quarkus-run.jar"
libdir="$project/deployments/quarkus-app/lib"
JAVA_HOME="/lib/jvm/java-11-openjdk"

test -f "$jarfile"
test -d "$libdir"

# Create a temporary directory for a module path
mkdir dependencies
cp $libdir/**/*.jar dependencies
# Calculate dependencies
$JAVA_HOME/bin/jdeps --module-path dependencies --ignore-missing-deps --multi-release 11 -R -s \
    "$jarfile" \
    "$libdir"/**/*.jar \
> deps.txt
# Clean up temporary directory
rm -rf dependencies

echo "Generating stripped-deps"
<deps.txt \
  grep 'java\|jdk\.'  | # mostly removes target/, but also jdk8internals
  sed -E "s/Warning: .*//" | #remove extraneous warnings
  sed -E "s/.*-> //"  | # remove src of src -> dep
  sed -E "s/.*\.jar//" | # remove extraneous dependencies
  sed "s#/.*##"       | # delete anything after a slash. in practice target/..
  sort | uniq |
tee stripped-deps.txt

echo "Checking against jdk modules"
$JAVA_HOME/bin/java --list-modules > java-modules.txt
cat java-modules.txt | sed "s/\\@.*//" > modules.txt
grep -Fx -f stripped-deps.txt modules.txt | tr '\n' ',' | tr -d "[:space:]" > module-deps.txt
echo "jdk.zipfs" >> module-deps.txt

echo "Linking jre"
$JAVA_HOME/bin/jlink --output quarkus-jre \
       	--add-modules $(cat module-deps.txt) \
	-G --no-header-files --no-man-pages

rm *.txt
cp -r quarkus-jre /deployments
